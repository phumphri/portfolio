<!DOCTYPE html>

{% extends "base.html" %}

{% block head %}
{{ super() }}


<script src="https://d3js.org/d3.v6.min.js" charset="utf-8"></script>

<meta name="viewport" content="width=device-width, initial-scale=1">

{% endblock %}

{% block title %}udemy{% endblock %}

{% block body %}
{{ super() }}
<script>
    // Define global variable dataset
    dataset = []
    year = 2020
    years = []
    resize = true
    svgRow = {}
    svgRow.width = 500
    svgRow.height = 500
    svg = null
    monthlySales = []
    topMargin = 1 - 0.05
    leftMargin = 0.05
    rightMargin = 0.05
    bottomMargin = 1.00 - 0.05
    scaleSalesDate = null
    scaleSalesVolume = null
    xAxis = d3.axisBottom()
    yAxis = d3.axisRight()
    yAxisScale = null

  

    // Define SVG attributes.
    var w = 500;
    var h = 500;
    // var baseline = h
    var padding = 2;        // Add spaces around the bars.

    // Get udemy sales data for a year.
    function getSalesVolume() {

        console.log("getSalesVolume was called for year:", year)

        var xmlhttp = new XMLHttpRequest()
        var url = "http://localhost:5000/sandbox_sales/" + year

        var parseTime = d3.timeParse("%Y-%m-%d")

        // Build the SVG when a valid response is returned.
        xmlhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                response = JSON.parse(this.responseText);
                dataset = response["udemy_volume"]

                // Convert the volume strings to type integer.
                // Conver the date string to type date.
                for (var i = 0; i < dataset.length; i++) {
                    dataset[i]["sales_volume"] = parseInt(dataset[i]["sales_volume"])
                    dataset[i]["sales_date"] = parseTime(dataset[i]["sales_date"])
                }
                years = response["udemy_year"]
                if (resize) {
                    createSVG()
                } else {
                    updateSVG()
                }
                console.log("dataset:", dataset)
            }
        };

        // Send the request and wait for the valid response.
        xmlhttp.open("GET", url, true);
        xmlhttp.send();
    }

    // Color bars:  Grey for lower than 100.  Otherwise, light red.
    function colorPicker(d) {
        if (d < 100) {
            return "#666666"
        } else {
            return "#FF0033"
        }
    }

    function createMonthlySales() {

        // Initialize monthly sales.
        monthlySales = []

        // Calculate the vertical scale based on sales volume and row height.
        var maxSalesVolume = d3.max(dataset, function (d) { return d["sales_volume"] })
        var minSalesVolume = d3.min(dataset, function (d) { return d["sales_volume"] })
        scaleSalesVolume = d3.scaleLinear()
            .domain([0, maxSalesVolume])
            .rangeRound([0, (svgRow.height * topMargin)])
        yAxisScale = d3.scaleLinear()
            .domain([0, maxSalesVolume])
            .rangeRound([(svgRow.height * topMargin), 0])
        if (true) {
            console.log(" ")
            console.log("Sales Volume:")
            console.log("minSalesVolume:", minSalesVolume, "maxSalesVolume:", maxSalesVolume)
            console.log("min y:", scaleSalesVolume(minSalesVolume), "max y:", scaleSalesVolume(maxSalesVolume))
        }

        // Calculate the horizontal scale based on sales date and row width.
        // Last date would be positioned at the edge of the svg.
        // By reducing the svgRow width by one datum, the last bar will be in the svg.
        var maxSalesDate = d3.max(dataset, function (d) { return d["sales_date"] })
        var minSalesDate = d3.min(dataset, function (d) { return d["sales_date"] })
        var leftMarginWidth = svgRow.width * leftMargin
        var rightMarginWidth = svgRow.width * rightMargin
        scaleSalesDate = d3.scaleTime()
            .domain([minSalesDate, maxSalesDate])
            .rangeRound([leftMarginWidth, (svgRow.width * (dataset.length / (dataset.length + 1))) - rightMarginWidth])
        if (true) {
            console.log(" ")
            console.log("Sales Date:")
            console.log("minSalesDate:", minSalesDate, "maxSalesDate:", maxSalesDate)
            console.log("min x:", scaleSalesDate(minSalesDate), "max x:", scaleSalesDate(maxSalesDate))
        }

        for (var i = 0; i < dataset.length; i++) {

            // Create datum of Monthly Sales.
            var d = {}

            // Bar dimensions
            // Height is used to draw a rectangle from y DOWN.
            // y is the top of the rectangle:  Bottom of the chart then up by the height.
            // The bottomMargin shrinks the bars up from the bottom of the svg.
            d.width = parseInt((svgRow.width / dataset.length * 0.8).toFixed(0))
            d.height = parseInt((scaleSalesVolume(dataset[i]["sales_volume"]) * bottomMargin).toFixed(0))
            d.x = parseInt(scaleSalesDate(dataset[i]["sales_date"]).toFixed(0))
            d.y = (500 * bottomMargin) - d.height;
            if (true) {
                console.log(" ")
                console.log("Bar Dimensions:")
                console.log("d.width:", d.width, "d.height:", d.height, "d.x:", d.x, "d.y:", d.y)
            }

            // Bar text
            try {
                d.text_x = d.x + d.width / 2;
                d.text = dataset[i]["sales_volume"]
            } catch (err) {
                console.log(" ")
                console.log("Text Dimensions:")
                console.log("err.message:", err.message)
                console.log("d.x:", d.x, "d.width:", d.width, "d.text_x:", d.text_x)
            }

            // Horizontal sales date 
            d.month_x = parseInt(scaleSalesDate(dataset[i]["sales_date"]).toFixed(0));
            console.log(" ")
            console.log("Dates for Axis")
            console.log('d.month_x:', d.month_x)

            monthlySales.push(d)
        }
        console.log(" ")
        console.log("monthlySales:")
        console.log(monthlySales)

    }

    function createSVG() {

        console.log("createSVG() was called for year:", year)

        // Remove the prior svg.
        x = document.getElementById("svg")
        if (x) {
            d3.select("#svg").remove()
        }

        // Create the a placeholder svg to get row dimensions.
        var column = d3.select("#svgColumn")
        svg = column.append("svg")
            .attr("width", 500)
            .attr("height", 500)
            .attr("id", "placeholder")

        // svgRow.width = document.getElementById("svgRow").offsetWidth
        // svgRow.height = document.getElementById("svgRow").offsetHeight
        svgRow.width = parseInt((document.getElementById("svgRow").getBoundingClientRect().width).toFixed(0))
        svgRow.height = parseInt((document.getElementById("svgRow").getBoundingClientRect().height).toFixed(0))
        if (true) {
            console.log(" ")
            console.log("svgRow dimensions")
            console.log("svgRow.height:", svgRow.height, "svgRow.width:", svgRow.width)
        }

        d3.select("#placeholder").remove();

        // Create the svg using the column dimensions.
        var row = d3.select("#svgRow")
        var column = row.select("#svgColumn")
        svg = column.append("svg")
            .attr("width", svgRow.width)
            .attr("height", svgRow.height)
            .attr("id", "svg")
        x = document.getElementById("svg")
        if (!x) {
            console.log("failed to created svg.")
        }

        // Create attributes from the dataset.
        // Create chart attributes based on raw sales data and visualization attributes.
        // This takes more memory.  Simpler code during plotting.  Calculate only once.
        // Centralize calculations.
        createMonthlySales()

        // Create bars from the array of attributes.
        svg.selectAll("rect")
            .data(monthlySales)
            .enter()
            .append("rect")                                                 // Bar chart.
            .attr("x", function (d) { return d.x; })                        // Spaced based on sales datate.
            .attr("y", function (d) { return d.y; })                        // Position at the top of the bar.
            .attr("width", function (d) { return d.width; })                // Fatten the rectangles to fill the view port.
            .attr("height", function (d) { return d.height; })              // Draw from the top of the bar down.
            .attr("class", "bar_chart")                                     // Used for selection.
            .style("fill", function (d) { return colorPicker(d.height); })  // Set the color of the bar.

        // Add text to the bars.
        svg.selectAll("text")
            .data(monthlySales)
            .enter()
            .append("text")
            .attr("text-anchor", "middle")
            .text(function (d) { return d.text; })
            .attr("x", function (d) { return d.text_x; })
            .attr("y", function (d) { return d.y + 24; })   // Slide the label down 18 pixels from the top o the bar.                        
            .attr("font-family", "sans-serif")              // Looks clearner.
            .attr("font-size", 12)
            .attr("class", "data_label")                    // Used for selection.
            .style("fill", "white")

        // Draw a line from the previous d to the current d.
        var lineFunc = d3.line()
            .x(function (d) { return d.text_x; })    // Draw the line segment to the horizontal center of a bar.
            .y(function (d) { return d.y; })    // Draw the line segment to the top of a bar.

        // Draw a shape that is not predefined in anyother of the commands.
        // Pass the data to the lineFunc and let it draw the line.
        var viz = svg.append("path")
            .attr("d", lineFunc(monthlySales))
            .attr("class", "line_chart")        // Used for selection.
            .attr("stroke", "yellow")
            .attr("stroke-width", 2)
            .attr("fill", "none")

        // Draw a scatter plot on top of the line and bars.
        var dots = svg.selectAll("circle")
            .data(monthlySales)
            .enter()
            .append("circle")
            .attr("cx", function (d) { return d.text_x; })  // Center the circle to the horizontal center of a bar.
            .attr("cy", function (d) { return d.y; })       // Center the circle to the top of a bar.
            .attr("r", 5)
            .attr("fill", "yellow")
            .attr("class", "scatter_plot")                  // Used for selection.

        // Add bottom axis.
        xAxis.scale(scaleSalesDate)
        leftPosition = parseInt((monthlySales[0]["width"] / 2).toFixed(0))
        svg.append("g")
            .attr("id", "xAxisG")
            .attr("class", "x_data_axis")     // Used for selection.
            .attr("transform", "translate(" + leftPosition + "," + (svgRow.height * bottomMargin) + ")" )
            .call(xAxis)

        // Apply an individual circle without a dataset.
        svg.append("circle")
            .attr("cx", 100)
            .attr("cy", 25)
            .attr('r', 25)
            .style("fill", "blue");

        // Apply an individual text without a dataset.
        svg.append("text")
            .text("Sales Volume for Year " + year)
            .attr("id", "svgTitle")
            .attr("x", 127)
            .attr("y", 30)
            .style("fill", "white");

        // Add vertical axis.
        yAxis.scale(yAxisScale)
        top_position = 0
        svg.append("g")
            .attr("id", "yAxisG")
            .attr("class", "y_data_axis")
            .attr("transform", "translate(0," + top_position + ")" )
            .call(yAxis)

        // Draw table of sales data.
        // Do not draw table it it already exists.
        // Limit the height of the column so the scroll bars are enabled.
        x = document.getElementById("table_row")
        if (x) {
            console.log("table_row exists.")
        } else {
            var headingRow = container.append("div")
                .attr("class", "row")
                .attr("id", "headingRow")
            headingRow.append("div")
                .attr("class", "col-sm-2")
                .append("fieldset")
                .append("legend")
                .text("Select Year")
            headingRow.append("div")
                .attr("class", "col-sm-3")
                .append("fieldset")
                .append("legend")
                .text("Select Visualization")
            headingRow.append("div")
                .attr("class", "col-sm-7")

            var table_row = container.append("div")
                .attr("class", "row")
                .attr("id", "table_row")
            var year_column = table_row.append("div")
                .attr("class", "col-sm-2")
                .attr("style", "color:white; font-family:sans-serif; overflow-y:auto; height:15em; ")
            var visualization_column = table_row.append("div")
                .attr("class", "col-sm-3")
                .attr("style", "color:white; font-family:sans-serif; overflow-y:auto; height:15em; ")
            table_row.append("div")
                .attr("class", "col-sm-7")

            // First time through the dataset, add the years.
            // Second time through the dataset, add the event listener.
            var year_table = year_column.append("table")
                .attr("class", "table")
            var year_tbody = year_table.append("tbody")
            year_tbody.selectAll("tr")
                .data(years)
                .enter()
                .append("tr")
                .append("td")
                .attr("id", function (d, i) { return "year_td" + i })
                .html(function (d) { return d; })
            year_tbody.selectAll("tr")
                .data(years)
                .on('click', function (d) {
                    console.log("click was called:", d.target.innerHTML);
                    year = d.target.innerHTML;
                    startUpdate()
                })
                
            // First time through the visualizations, add the visualizations.
            // Second time through the dataset, add the event listener.
            visualizations = [
                ["Bar Chart", "bar_chart"],
                ["Line Chart", "line_chart"],
                ["Labels", "data_label"],
                ["Scatter Plot", "scatter_plot"],
                ["x Axis", "x_data_axis"],
                ["y Axis", "y_data_axis"]
            ]
            var visualization_table = visualization_column.append("table")
                .attr("class", "table")
            var visualization_tbody = visualization_table.append("tbody")
            visualization_tbody.selectAll("tr")
                .data(visualizations)
                .enter()
                .append("tr")
                .append("td")
                .append("input")
                .attr("type", "checkbox")
                .attr("checked", "true")
                .attr("id", function(d, i) { return d[1]})
            visualization_tbody.selectAll("td")
                .data(visualizations)
                .append("label")
                .attr("for", function(d) { return "checkbox_" + d[1]})
                .html(function(d) { return d[0]})
            visualization_tbody.selectAll("input")
                .data(visualizations)   // bar_chart, line_chart, data_label, scatter_plot, data_axis
                .on('click', function (d) {
                    console.log(" ")
                    console.log("d:")
                    console.log(d)
                    var chart_element = "." + d.target.id
                    if (this.checked) {
                        console.log(chart_element, "was selected.")
                        d3.selectAll(chart_element)
                            .classed("hidden", false)
                    } else {
                        console.log(chart_element, "was unselected.")
                        d3.selectAll(chart_element)
                            .classed("hidden", true)
                    }
                })
        }
    }

    function updateSVG() {

        console.log("updateSVG() was called for year:", year)

        // Create attributes from the dataset.
        // Create chart attributes based on raw sales data and visualization attributes.
        // This takes more memory.  Simpler code during plotting.  Calculate only once.
        // Centralize calculations.
        createMonthlySales()

        // Create bars from the array of attributes.
        svg.selectAll("rect")
            .data(monthlySales)
            .transition()
            .duration(1000)
            .attr("x", function (d) { return d.x; })                    // Space evenly in the view port.
            .attr("y", function (d) { return d.y; })                    // Position at the top of the bar.
            .attr("width", function (d) { return d.width; })                // Fatten the rectangles to fill the view port.
            .attr("height", function (d) { return d.height; })              // Draw from the top of the bar down.
            .style("fill", function (d) { return colorPicker(d.height); })  // Set the color of the bar.

        // Add text to the bars.
        svg.selectAll("text")
            .data(monthlySales)
            .transition()
            .duration(1000)
            .text(function (d) { return d.text; })
            .attr("x", function (d) { return d.text_x; })
            .attr("y", function (d) { return d.y + 24; })   // Slide the label down 18 pixels from the top o the bar.                        

        // Draw a line from the previous d to the current d.
        var lineFunc = d3.line()
            .x(function (d) { return d.text_x; })    // Draw the line segment to the horizontal center of a bar.
            .y(function (d) { return d.y; })    // Draw the line segment to the top of a bar.

        // Draw a shape that is not predefined in anyother of the commands.
        // Pass the data to the lineFunc and let it draw the line.
        var viz = svg.select("path")
            .transition()
            .duration(1000)
            .attr("d", lineFunc(monthlySales))
            .attr("stroke", "yellow")
            .attr("stroke-width", 2)
            .attr("fill", "none")

        // Draw a scatter plot on top of the line and bars.
        var dots = svg.selectAll("circle")
            .data(monthlySales)
            .transition()
            .duration(1000)
            .attr("cx", function (d) { return d.text_x; })   // Center the circle to the horizontal center of a bar.
            .attr("cy", function (d) { return d.y; })   // Center the circle to the top of a bar.

        // Apply an individual text without a dataset.
        svg.select("#svgTitle")
            .text("Sales Volume for Year " + year)


        // Update bottom axis.
        xAxis.scale(scaleSalesDate)
        leftPosition = parseInt((monthlySales[0]["width"] / 2).toFixed(0))
        svg.select("#xAxisG")
            .attr("transform", "translate(" + leftPosition + "," + (svgRow.height * bottomMargin) + ")" )
            .call(xAxis)

        // Update vertical axis.
        yAxis.scale(yAxisScale)
        top_position = 0
        svg.select("#yAxisG")
            .transition()
            .duration(1000)
            .attr("transform", "translate(0," + top_position + ")" )
            .call(yAxis)


    }

    function startUpdate() {
        resize = false;
        getSalesVolume();
    }

    function startResize() {
        resize = true;
        getSalesVolume();
    }

    // Using bootstrap, create row and column for the svg.
    var body = d3.select("body")
    body.attr("onresize", "startResize()")

    var container = body.append("div")
        .attr("class", "container-fluid")

    var row = container.append("div")
        .attr("class", "row")
        .attr("id", "svgRow")

    var column = row.append("div")
        .attr("class", "col-sm-12")
        .attr("id", "svgColumn")

    startResize()





</script>
{% endblock %}